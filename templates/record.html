<!DOCTYPE html>
<html>
  <head>
    <title>Record Audio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f4f4f4;
        padding: 40px;
      }
      form,
      #statusMessage,
      canvas {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 300px;
        margin: 20px auto;
        display: block;
      }
      h1,
      h3 {
        text-align: center;
        color: #333;
      }
      select,
      input[type="text"],
      button {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        margin-top: 20px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      #statusMessage {
        text-align: center;
        color: #333;
        display: none; /* hidden by default */
      }
      canvas {
        display: block; /* ensures the canvas is not inline */
        background: #fff; /* white background for visibility */
        border: 1px solid #ccc; /* consistent with other elements */
        margin-top: 20px;
      }
      #recordingStatus {
        color: gray; /* Default color */
        text-align: center;
        padding: 10px;
        font-size: 20px;
        border-radius: 5px;
        transition: color 0.5s ease; /* Smooth transition for color changes */
      }

      .recording-in-progress {
        color: red;
        animation: pulse 1s infinite; /* Animation for pulsing effect */
      }

      .recording-stopped {
        color: gray;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <h1>Welcome.</h1>
    <h3>
      One on One Meeting between {{ username }} and {{ firstname }} {{ lastname
      }} on {{ date }}.
    </h3>
    <button id="startButton" onclick="startRecording()">Start Recording</button>
    <button id="stopButton" onclick="stopRecording()" style="display: none">
      End Recording
    </button>
    <button id="pauseButton" onclick="pauseRecording()" style="display: none">
      Pause Recording
    </button>
    <button id="resumeButton" onclick="resumeRecording()" style="display: none">
      Resume Recording
    </button>
    <div id="statusMessage" style="display: none">Recording Complete</div>
    <div id="recordingStatus" class="recording-stopped">Recording stopped</div>
    <button onclick="goBack()">Back</button>
    <script>
      let mediaRecorder;
      let stream; // Global variable to hold the media stream
      let segmentCounter = 0;
      let segmentInterval;
      const socket = io();

      const username = "{{ username }}";
      const firstname = "{{ firstname }}";
      const lastname = "{{ lastname }}";
      const date = "{{ date }}";

      function startRecording() {
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((mediaStream) => {
            stream = mediaStream;
            mediaRecorder = new MediaRecorder(stream);
            recordingStatus.textContent = "Recording in progress";
            recordingStatus.className = "recording-in-progress"; // Apply pulsing red style
            document.getElementById("startButton").style.display = "none";
            document.getElementById("stopButton").style.display = "block";
            document.getElementById("pauseButton").style.display = "block";
            console.log("Recording started");
            mediaRecorder.start();

            segmentCounter = 1;
            segmentInterval = setInterval(() => {
              if (mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
              }
            }, 60000); // Stop the recording every minute

            mediaRecorder.ondataavailable = function (event) {
              if (event.data.size > 0) {
                const fileKey = `${username}_${firstname}${lastname}_${date}/${segmentCounter}.webm`;
                segmentCounter++;
                socket.emit("audio_chunk", {
                  audioData: event.data,
                  key: fileKey,
                  username: username,
                  date: date,
                });

                // Check if mediaRecorder is defined before starting it again
                if (mediaRecorder) {
                  mediaRecorder.start(); // Restart recording for the next segment
                }
              }
            };
          })
          .catch((error) => {
            if (
              error.name === "NotFoundError" ||
              error.name === "DevicesNotFoundError"
            ) {
              console.error("No recording device detected");
              alert("No recording device detected");
            } else {
              console.error("Error accessing the microphone: ", error);
            }
          });
      }

      function stopRecording() {
        console.log("Stop button clicked");
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          clearInterval(segmentInterval);

          mediaRecorder.onstop = () => {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
              const fileKey = `${username}_${date}/${segmentCounter}.webm`;
              socket.emit("audio_chunk", {
                audioData: mediaRecorder,
                key: fileKey,
                username: username,
                date: date,
              });
            }

            // Send the audio_end event after a short delay to ensure all chunks are processed
            setTimeout(() => {
              socket.emit("audio_end", {
                username: username,
                date: date,
              });
            }, 1000); // Adjust the delay as necessary

            // Release the microphone
            stream.getTracks().forEach((track) => track.stop());
            stream = null;
            mediaRecorder = null;
          };

          mediaRecorder.stop();
          recordingStatus.textContent = "Recording stopped";
          recordingStatus.className = "recording-stopped"; // Change to gray
          console.log("Recording stopped");
          document.getElementById("stopButton").style.display = "none";
          document.getElementById("pauseButton").style.display = "none";
          document.getElementById("resumeButton").style.display = "none";
          document.getElementById("statusMessage").style.display = "block";
        } else {
          console.log("Recorder is inactive or not defined");
        }
      }

      function pauseRecording() {
        // Check to make sure the recorder exists and is not inactive or paused
        if (mediaRecorder && mediaRecorder.state === "recording") {
          // Update media recorder to paused
          mediaRecorder.pause();
          recordingStatus.textContent = "Recording stopped";
          recordingStatus.className = "recording-stopped"; // Change to gray
          // Let the client know the recording is paused
          console.log("Recording is paused");
          // Hide the pause button and show the resume button
          document.getElementById("pauseButton").style.display = "none";
          document.getElementById("resumeButton").style.display = "block";
        }
      }

      function resumeRecording() {
        // Check to make sure the recorder exists and is not inactive or recording
        if (mediaRecorder && mediaRecorder.state === "paused") {
          // Update media recorder to resume
          mediaRecorder.resume();
          recordingStatus.textContent = "Recording in progress";
          recordingStatus.className = "recording-in-progress"; // Resume pulsing red style
          // Let the client know the recording is resumed
          console.log("Recording resumed");
          // Hide the resume button and show the pause button
          document.getElementById("resumeButton").style.display = "none";
          document.getElementById("pauseButton").style.display = "block";
        }
      }

      function goBack() {
        // Go back one page
        window.history.back();
      }
    </script>
  </body>
</html>
